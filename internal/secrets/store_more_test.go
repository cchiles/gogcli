package secrets

import (
	"errors"
	"runtime"
	"strings"
	"testing"
	"time"

	"github.com/99designs/keyring"
)

func TestKeyringStore_ListDeleteDefault(t *testing.T) {
	ring := keyring.NewArrayKeyring(nil)
	store := &KeyringStore{ring: ring}

	tok1 := Token{Email: "a@b.com", RefreshToken: "rt1", CreatedAt: time.Now()}
	tok2 := Token{Email: "c@d.com", RefreshToken: "rt2", CreatedAt: time.Now()}
	if err := store.SetToken(tok1.Email, tok1); err != nil {
		t.Fatalf("SetToken: %v", err)
	}
	if err := store.SetToken(tok2.Email, tok2); err != nil {
		t.Fatalf("SetToken: %v", err)
	}

	tokens, err := store.ListTokens()
	if err != nil {
		t.Fatalf("ListTokens: %v", err)
	}
	if len(tokens) != 2 {
		t.Fatalf("expected 2 tokens, got %d", len(tokens))
	}

	if err := store.DeleteToken(tok1.Email); err != nil {
		t.Fatalf("DeleteToken: %v", err)
	}
	if _, err := store.GetToken(tok1.Email); err == nil {
		t.Fatalf("expected error for deleted token")
	}

	if err := store.SetDefaultAccount("a@b.com"); err != nil {
		t.Fatalf("SetDefaultAccount: %v", err)
	}
	def, err := store.GetDefaultAccount()
	if err != nil {
		t.Fatalf("GetDefaultAccount: %v", err)
	}
	if def != "a@b.com" {
		t.Fatalf("unexpected default account: %q", def)
	}

	emptyStore := &KeyringStore{ring: keyring.NewArrayKeyring(nil)}
	if def, err := emptyStore.GetDefaultAccount(); err != nil || def != "" {
		t.Fatalf("expected empty default account, got %q err=%v", def, err)
	}
}

func TestParseTokenKey(t *testing.T) {
	if email, ok := ParseTokenKey("token:a@b.com"); !ok || email != "a@b.com" {
		t.Fatalf("unexpected parse: %q ok=%v", email, ok)
	}
	if _, ok := ParseTokenKey("nope"); ok {
		t.Fatalf("expected invalid token key")
	}
}

func TestAllowedBackends(t *testing.T) {
	if _, err := allowedBackends(KeyringBackendInfo{Value: "keychain"}); err != nil {
		t.Fatalf("keychain allowed: %v", err)
	}
	if _, err := allowedBackends(KeyringBackendInfo{Value: "file"}); err != nil {
		t.Fatalf("file allowed: %v", err)
	}
}

func TestWrapKeychainError(t *testing.T) {
	err := errors.New("test -25308 error")
	wrapped := wrapKeychainError(err)
	if runtime.GOOS == "darwin" {
		if wrapped == err || !strings.Contains(wrapped.Error(), "keychain is locked") {
			t.Fatalf("expected wrapped keychain error, got: %v", wrapped)
		}
		return
	}
	if wrapped != err {
		t.Fatalf("expected passthrough error, got: %v", wrapped)
	}
}

func TestFileKeyringPasswordFuncFrom(t *testing.T) {
	fn := fileKeyringPasswordFuncFrom("pw", false)
	got, err := fn("prompt")
	if err != nil {
		t.Fatalf("expected password, got err: %v", err)
	}
	if got != "pw" {
		t.Fatalf("unexpected password: %q", got)
	}

	fn = fileKeyringPasswordFuncFrom("", false)
	_, err = fn("prompt")
	if err == nil || !errors.Is(err, errNoTTY) {
		t.Fatalf("expected no TTY error, got: %v", err)
	}
}
